<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <title>Herramientas M√©dicas - UmbraMed.Org</title>
    <!-- Inlined critical styles extracted from styles.css -->
    <style>
    :root { --primary-red:#C41E3A;--dark-red:#8B0000;--blood-red:#880808;--warning-red:#FF4444;--success-green:#28a745;--light-bg:#FFFFFF;--lighter-bg:#F8F9FA;--text-dark:#343A40;--text-light:#6C757D;--accent-black:#1A1A1A; }
    body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;background:var(--light-bg);color:var(--text-dark);} .header{position:fixed;top:0;left:0;right:0;background:var(--lighter-bg);border-bottom:2px solid var(--primary-red);z-index:1000;padding:.5rem;} .nav-container{display:flex;justify-content:space-between;align-items:center;max-width:1400px;margin:0 auto;padding:0 1rem;} .logo-container{display:flex;align-items:center;gap:.75rem;} .brand-text{font-weight:800;font-size:2rem;color:var(--primary-red);letter-spacing:2px;text-shadow:0 0 6px rgba(196,30,58,.2);} .subtitle{font-size:.65rem;color:var(--text-light);letter-spacing:2px;margin-top:2px;font-weight:600;} .nav-menu{display:flex;gap:2rem;list-style:none;margin:0;padding:0;} .nav-item a{color:var(--text-dark);text-decoration:none;font-weight:600;text-transform:uppercase;letter-spacing:1px;position:relative;padding:.5rem 0;} .nav-item a:hover,.nav-item a.active{color:var(--primary-red);} .nav-item a::after{content:'';position:absolute;bottom:-2px;left:0;width:0;height:2px;background:var(--primary-red);transition:width .3s ease;} .nav-item a:hover::after,.nav-item a.active::after{width:100%;}
    /* Logo ADN redise√±ado */
    .logo-dna{width:58px;height:58px;position:relative;perspective:800px;}
    .logo-dna svg{width:100%;height:100%;display:block;stroke:var(--primary-red);filter:drop-shadow(0 0 4px rgba(196,30,58,.35));animation:helix-spin 22s linear infinite;transform-style:preserve-3d;}
    @keyframes helix-spin{0%{transform:rotateY(0deg) rotateZ(0deg);}100%{transform:rotateY(360deg) rotateZ(360deg);}}
    /* Reducir grosor l√≠neas para tama√±o menor */
    .logo-dna svg path{stroke-width:3.2;} .logo-dna svg line{stroke-width:1.6;} .logo-dna svg circle{fill:var(--primary-red);}
    .main-content{margin-top:120px;padding:2rem;} .section-title{font-family:'Orbitron',monospace;font-size:2.2rem;font-weight:700;color:var(--primary-red);text-align:center;margin-bottom:2rem;} .tools-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:2rem;max-width:1400px;margin:0 auto;} .tool-card{background:linear-gradient(145deg,var(--light-bg),var(--lighter-bg));border:1px solid var(--primary-red);border-radius:8px;padding:2rem;transition:.3s;position:relative;overflow:hidden;box-shadow:0 2px 10px rgba(196,30,58,.1);} .tool-card:hover{transform:translateY(-5px);border-color:var(--blood-red);box-shadow:0 10px 30px rgba(196,30,58,.2);} .tool-icon{font-size:3rem;color:var(--primary-red);margin-bottom:1rem;display:block;} .tool-title{font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:700;color:var(--accent-black);margin-bottom:1rem;} .tool-description{color:var(--text-light);margin-bottom:1.5rem;line-height:1.6;} .tool-link, .tool-card a.tool-link, .tool-card button.tool-link{display:inline-block;background:linear-gradient(45deg,var(--primary-red),var(--dark-red));color:#fff !important;text-decoration:none;padding:.8rem 1.5rem;border-radius:5px;font-weight:600;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border:none;transition:.3s;font-family:'Rajdhani',sans-serif;} .tool-card a.tool-link:hover, .tool-card button.tool-link:hover{background:linear-gradient(45deg,var(--blood-red),var(--primary-red));transform:scale(1.05);box-shadow:0 5px 15px rgba(196,30,58,.3);} .footer{background:var(--lighter-bg);border-top:2px solid var(--primary-red);padding:3rem 2rem 2rem;margin-top:4rem;text-align:center;} .footer-content{max-width:1400px;margin:0 auto;} .footer p{color:var(--text-light);font-size:.9rem;margin:.5rem 0;}
    @media (max-width:768px){.nav-container{flex-direction:column;gap:1rem;padding:1rem;} .nav-menu{flex-wrap:wrap;gap:1rem;justify-content:center;} .brand-text{font-size:2rem;} .tools-grid{grid-template-columns:1fr;padding:0 1rem;} .main-content{margin-top:180px;padding:1rem;}}
    </style>
</head>
<body>
    <script src="js/common.js"></script>
    <script>document.addEventListener('DOMContentLoaded',()=>UmbramedComponents.init('herramientas'));</script>

    <main class="main-content">
        <section class="tools-section">
            <h2 class="section-title">HERRAMIENTAS M√âDICAS</h2>
            <div class="tools-grid" id="tools-grid">
                <!-- Las tarjetas de herramientas se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 UMBRAMED Medical Division. Todos los derechos reservados.</p>
            <p>Desarrollado para profesionales sanitarios de Andaluc√≠a.</p>
        </div>
    </footer>

    <!-- Embedded script: tools rendering + validation -->
    <script src="js/versioning.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toolsGrid = document.getElementById('tools-grid');
            const HIDDEN_KEY='herramientas_hidden_v1';
            const ORDER_KEY='herramientas_order_v1';
            const hiddenIds = new Set(JSON.parse(localStorage.getItem(HIDDEN_KEY)||'[]'));
            const savedOrder = JSON.parse(localStorage.getItem(ORDER_KEY)||'[]');
            function persist(){localStorage.setItem(HIDDEN_KEY,JSON.stringify([...hiddenIds]));localStorage.setItem(ORDER_KEY,JSON.stringify(savedOrder));}
            function fetchTools(){return fetch('data/herramientas.json').then(r=>r.json());}
            function baseExtras(){return [
                {id:'dietas-ia',title:'Asistente Nutricional IA',description:'Genera planes diet√©ticos, gu√≠as de nutrientes, interacciones y recomendaciones por patolog√≠a. Versi√≥n BETA auto-contenida (revisar cl√≠nicamente).',link:'asistente_dietas.html',icon:'ü•ó',status:'functional',button_text:'Abrir Asistente'},
                {id:'diabetes-tipo-2',title:'Asistente de Diabetes Tipo 2',description:'Una herramienta integral para ayuda en el control de diabetes tipo 2.',link:'docs/unzipped_diabetes_tipo_2/index.html',icon:'ü©∏',status:'development',button_text:'En Migraci√≥n'},
                {id:'campus-kike',title:'Campus OPE Kike',description:'Acceso privado: test r√°pido, simulacros, repaso de fallos y banco PAI/OPE 2025 (requiere login kike).',link:'campus_kike.html',icon:'üî•',status:'featured',button_text:'Entrar Campus'}
            ];}
            function applyOrder(arr){if(!savedOrder.length) return arr;const map=new Map(arr.map(t=>[t.id,t]));const ordered=[];savedOrder.forEach(id=>{if(map.has(id)&&!hiddenIds.has(id))ordered.push(map.get(id));});arr.forEach(t=>{if(!ordered.includes(t)&&!hiddenIds.has(t.id))ordered.push(t);});return ordered;}
            function render(tools){toolsGrid.innerHTML='';tools.forEach(tool=>{const card=document.createElement('div');card.className='tool-card';card.dataset.id=tool.id;let style='';let buttonDisabled=false;let buttonStyle='';let link=tool.link;switch(tool.status){case'featured':style='border-color:#667eea;background:linear-gradient(135deg,#f8f9ff 0%,#e8ecff 100%);order:-1;';buttonStyle='background:#667eea;border-color:#667eea;font-weight:600;';break;case'development':style='opacity:.6;border-color:#6C757D;';buttonDisabled=true;buttonStyle='background:#6C757D;cursor:not-allowed;';link='#';break;}card.setAttribute('style',style);card.innerHTML=`<div class="edit-overlay" style="display:none;position:absolute;top:6px;right:6px;z-index:5;display:flex;gap:4px;"><button class="btn-remove" title="Eliminar" style="background:#dc2626;border:none;color:#fff;font-size:.6rem;padding:.35rem .5rem;border-radius:6px;cursor:pointer;font-weight:600;">‚úï</button><span class="drag-handle" title="Arrastrar" style="background:#334155;color:#fff;font-size:.6rem;padding:.35rem .45rem;border-radius:6px;cursor:grab;font-weight:600;">‚Üï</span></div>
                        <span class="tool-icon" style="color:${tool.status==='featured'?'#667eea':(tool.status==='development'?'#6C757D':'inherit')};font-size:${tool.status==='featured'?'3rem':'2rem'};">${tool.icon}</span>
                        <h3 class="tool-title" style="color:${tool.status==='featured'?'#667eea':(tool.status==='development'?'#6C757D':'inherit')};font-size:${tool.status==='featured'?'1.4rem':'1.2rem'};">${tool.title}</h3>
                        <p class="tool-description" style="${tool.status==='featured'?'font-weight:500;':''}">${tool.description}</p>
                        ${buttonDisabled?`<button class="tool-link" disabled style="${buttonStyle}">${tool.button_text}</button>`:`<a href="${link}" class="tool-link" style="${buttonStyle}">${tool.button_text}</a>`}`;toolsGrid.appendChild(card);});}
                        const ADD_KEY='herramientas_added_v1';
                        function loadAdded(){try{return JSON.parse(localStorage.getItem(ADD_KEY)||'[]');}catch{return []}}
                        function saveAdded(list){localStorage.setItem(ADD_KEY,JSON.stringify(list));}
                        function loadAndRender(){fetchTools().then(json=>{const all=[...json];const extras=baseExtras();extras.forEach(e=>{if(!all.some(t=>t.id===e.id)) all.push(e);});const added=loadAdded();added.forEach(a=>{if(!all.some(t=>t.id===a.id)) all.push(a);});const filtered=all.filter(t=>!hiddenIds.has(t.id));const ordered=applyOrder(filtered);render(ordered);setupEditorUI();}).catch(err=>{console.error('Error al cargar herramientas',err);toolsGrid.innerHTML='<p>Error al cargar las herramientas.</p>';});}
                        function isAdmin(){try{const s=window.UmbraAuthCore?.getSession();if(!s) return false;const allowed=['kike@umbramed.org','valerio.trigos88@gmail.com'];return allowed.includes(s.email)||s.role==='admin';}catch{return false;}}
                        function setupEditorUI(){if(!isAdmin()) return;let panel=document.getElementById('editorToolsPanel');if(!panel){panel=document.createElement('div');panel.id='editorToolsPanel';panel.style.cssText='position:fixed;bottom:15px;right:15px;z-index:2000;background:#1e293b;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.3);display:flex;flex-direction:column;gap:6px;min-width:230px;font-family:system-ui,sans-serif;font-size:.65rem;';panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><strong style="font-size:.7rem;letter-spacing:.5px;">MODO EDICI√ìN</strong><label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-weight:600;"><input id="toggleEdit" type="checkbox" style="transform:scale(1.1);cursor:pointer;"> <span>ON</span></label></div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button id="btnExport" style="flex:1;background:#0d9488;border:none;color:#fff;padding:6px 8px;border-radius:6px;font-weight:600;cursor:pointer;">Exportar</button>
                            <button id="btnAdd" style="flex:1;background:#6366f1;border:none;color:#fff;padding:6px 8px;border-radius:6px;font-weight:600;cursor:pointer;">A√±adir</button>
                            <button id="btnResetHidden" style="flex:1;background:#dc2626;border:none;color:#fff;padding:6px 8px;border-radius:6px;font-weight:600;cursor:pointer;">Reset</button>
                        </div>
                        <form id="addForm" style="display:none;flex-direction:column;gap:4px;background:#0f172a;padding:8px;border-radius:8px;margin-top:4px;" onsubmit="return false;">
                            <input name="id" placeholder="id" required style="padding:4px 6px;font-size:.6rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#fff;">
                            <input name="title" placeholder="T√≠tulo" required style="padding:4px 6px;font-size:.6rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#fff;">
                            <textarea name="description" placeholder="Descripci√≥n" rows="2" required style="padding:4px 6px;font-size:.6rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#fff;"></textarea>
                            <input name="link" placeholder="enlace.html" required style="padding:4px 6px;font-size:.6rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#fff;">
                            <input name="icon" placeholder="Icono (emoji)" style="padding:4px 6px;font-size:.6rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#fff;">
                            <select name="status" style="padding:4px 6px;font-size:.6rem;border:1px solid #334155;border-radius:4px;background:#1e293b;color:#fff;">
                                <option value="functional">functional</option>
                                <option value="featured">featured</option>
                                <option value="development">development</option>
                            </select>
                            <button type="submit" style="margin-top:4px;background:#10b981;border:none;color:#fff;padding:6px 8px;border-radius:6px;font-weight:600;cursor:pointer;">Guardar</button>
                        </form>
                        <div id="exportBox" style="display:none;flex-direction:column;gap:4px;">
                            <textarea readonly style="width:260px;height:140px;font-size:.6rem;padding:6px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;"></textarea>
                            <button id="btnCopy" style="background:#6366f1;border:none;color:#fff;padding:6px 8px;border-radius:6px;font-weight:600;cursor:pointer;">Copiar</button>
                        </div>
                        <div style="font-size:.55rem;line-height:1.3;color:#94a3b8;">Solo administradores. Arrastra para reordenar. ‚úï elimina (local). A√±ade m√≥dulos y exporta JSON.</div>`;document.body.appendChild(panel);}const toggle=document.getElementById('toggleEdit');const exportBtn=document.getElementById('btnExport');const addBtn=document.getElementById('btnAdd');const resetBtn=document.getElementById('btnResetHidden');const exportBox=document.getElementById('exportBox');const copyBtn=document.getElementById('btnCopy');const addForm=document.getElementById('addForm');toggle.onchange=()=>setEditMode(toggle.checked);exportBtn.onclick=()=>{exportBox.style.display=exportBox.style.display==='flex'?'none':'flex';if(exportBox.style.display==='flex'){const allCards=[...document.querySelectorAll('.tool-card')];const payload=allCards.map(c=>collectCardData(c.dataset.id));exportBox.querySelector('textarea').value=JSON.stringify(payload,null,2);} };copyBtn.onclick=()=>{const ta=exportBox.querySelector('textarea');ta.select();document.execCommand('copy');copyBtn.textContent='Copiado';setTimeout(()=>copyBtn.textContent='Copiar',1200);};addBtn.onclick=()=>{addForm.style.display=addForm.style.display==='flex'?'none':'flex';};addForm.onsubmit=()=>{const fd=new FormData(addForm);const id=(fd.get('id')||'').trim();if(!id){alert('ID requerido');return false;}const added=loadAdded();if(added.some(a=>a.id===id)){alert('ID ya existe');return false;}const tool={id,title:fd.get('title')||'',description:fd.get('description')||'',link:fd.get('link')||'#',icon:fd.get('icon')||'üß©',status:fd.get('status')||'functional',button_text:'Abrir'};added.push(tool);saveAdded(added);savedOrder.push(id);persist();addForm.reset();addForm.style.display='none';loadAndRender();return false;};resetBtn.onclick=()=>{if(confirm('Restaurar orden, mostrar y borrar a√±adidos locales?')){hiddenIds.clear();savedOrder.splice(0,savedOrder.length);saveAdded([]);persist();loadAndRender();}};decorateCards();}
            function collectCardData(id){const card=document.querySelector(`.tool-card[data-id="${id}"]`);if(!card) return null;const title=card.querySelector('.tool-title')?.textContent||'';const description=card.querySelector('.tool-description')?.textContent||'';const icon=card.querySelector('.tool-icon')?.textContent||'';const link=card.querySelector('a.tool-link')?.getAttribute('href')||'#';return {id,title,description,link,icon,status:'functional',button_text:(card.querySelector('a.tool-link')||card.querySelector('button.tool-link'))?.textContent||'ABRIR'};}
            function setEditMode(on){document.body.classList.toggle('editing-tools',on);[...document.querySelectorAll('.tool-card')].forEach(c=>{const overlay=c.querySelector('.edit-overlay');if(overlay) overlay.style.display=on?'flex':'none';c.draggable=on;c.classList.toggle('draggable',on);});if(on) attachDnD();}
            function decorateCards(){[...document.querySelectorAll('.tool-card')].forEach(c=>{if(!c.querySelector('.edit-overlay')) return;const removeBtn=c.querySelector('.btn-remove');removeBtn.onclick=()=>{const id=c.dataset.id;if(confirm('Eliminar m√≥dulo '+id+'?')){hiddenIds.add(id);persist();c.remove();}};});}
            function attachDnD(){const cards=[...document.querySelectorAll('.tool-card')];cards.forEach(card=>{card.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',card.dataset.id);card.classList.add('dragging');});card.addEventListener('dragend',()=>{card.classList.remove('dragging');updateOrder();});card.addEventListener('dragover',e=>{e.preventDefault();const dragging=document.querySelector('.tool-card.dragging');if(!dragging||dragging===card)return;const rect=card.getBoundingClientRect();const before=(e.clientY-rect.top)<rect.height/2;card.parentNode.insertBefore(dragging,before?card:card.nextSibling);});});}
            function updateOrder(){const ids=[...document.querySelectorAll('.tool-card')].map(c=>c.dataset.id);savedOrder.splice(0,savedOrder.length,...ids.filter(id=>!hiddenIds.has(id)));persist();}
            loadAndRender();
            // Reactivar UI edici√≥n al loguear / limpiar al salir
            window.addEventListener('umbramed:login', () => {
                setTimeout(()=>loadAndRender(),50);
            });
            window.addEventListener('umbramed:logout', () => {
                const panel=document.getElementById('editorToolsPanel');
                if(panel) panel.remove();
                hiddenIds.clear(); // opcional: limpiar ocultos al salir
            });
        });

        // Funci√≥n para mostrar login
        function showLogin(){window.location.href='academia.html';}

        // Simple link & data validator (non-blocking)
        (function(){
            const origin=location.origin;
            document.querySelectorAll('a[href$=".html"]').forEach(a=>{
                const url=new URL(a.getAttribute('href'),origin);
                fetch(url.pathname,{method:'HEAD'}).then(r=>{if(!r.ok)console.warn('[VALIDATION] Broken link',url.pathname);}).catch(()=>console.warn('[VALIDATION] Missing link',url.pathname));
            });
            fetch('data/herramientas.json',{method:'HEAD'}).then(r=>{if(!r.ok)console.warn('[VALIDATION] Missing data herramientas.json');});
        })();
    </script>
</body>
</html>
