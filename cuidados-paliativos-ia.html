<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a de Apoyo en Cuidados Paliativos - umbramed.org</title>
    <!-- Inlined styles -->
    <style>
    :root { --primary-red:#C41E3A;--dark-red:#8B0000;--blood-red:#880808;--warning-red:#FF4444;--success-green:#16a34a;--light-bg:#FFFFFF;--lighter-bg:#F8F9FA;--text-dark:#343A40;--text-light:#6C757D; }
    body{margin:0;font-family:'Rajdhani',sans-serif;background:var(--light-bg);color:var(--text-dark);} header.header-container{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:var(--lighter-bg);border-bottom:2px solid var(--primary-red);} header .logo{height:48px;} header h1{margin:0;font-size:1.4rem;color:var(--primary-red);} nav ul.nav-links{list-style:none;display:flex;gap:1rem;margin:0;padding:0;} nav ul.nav-links li a{text-decoration:none;color:var(--text-dark);font-weight:600;letter-spacing:.5px;} nav ul.nav-links li a:hover{color:var(--primary-red);} main.container{max-width:1100px;margin:2rem auto;padding:0 1rem;} footer{text-align:center;padding:2rem 1rem;margin-top:3rem;background:var(--lighter-bg);border-top:2px solid var(--primary-red);font-size:.85rem;color:var(--text-light);} 
    .text-center{text-align:center}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-12{margin-bottom:3rem}.mt-2{margin-top:.5rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.ml-2{margin-left:.5rem}.mx-auto{margin-left:auto;margin-right:auto}.max-w-xs{max-width:20rem}.max-w-2xl{max-width:42rem}.w-full{width:100%}.hidden{display:none}.flex{display:flex}.gap-2{gap:.5rem}.items-start{align-items:flex-start}.space-y-6>*+*{margin-top:1.5rem}.space-y-2>*+*{margin-top:.5rem}
    .text-2xl{font-size:1.5rem}.text-sm{font-size:.875rem}.text-xs{font-size:.75rem}.font-bold{font-weight:700}.font-semibold{font-weight:600}.text-slate-700{color:#334155}.text-slate-500{color:#64748b}.text-slate-600{color:#475569}.text-sky-500{color:#0ea5e9}.text-red-600{color:#dc2626}
    .pali-assist-container{max-width:800px;margin:2rem auto;padding:2rem;background:#f9fafb;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1);} .role-selection-container{display:flex;flex-direction:column;gap:2rem;justify-content:center;align-items:center;} @media (min-width:768px){.role-selection-container{flex-direction:row}}
    .role-card{background:#fff;padding:2rem;border-radius:.75rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);border:1px solid #e5e7eb;transition:.3s;cursor:pointer;width:100%;max-width:24rem;text-align:center;} .role-card:hover{transform:translateY(-4px);box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);border-color:#0ea5e9;} .role-icon{font-size:2.5rem;margin-bottom:1rem;} .role-title{font-size:1.25rem;font-weight:700;color:#1e293b;margin-bottom:.5rem;} .role-description{color:#64748b;}
    .back-button{margin-bottom:1.5rem;font-size:.875rem;font-weight:600;color:#0ea5e9;background:none;border:none;cursor:pointer;transition:color .2s;} .back-button:hover{color:#0c4a6e;}
    .view-content{background:#fff;padding:2rem;border-radius:.75rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);border:1px solid #e5e7eb;} .view-title{font-size:1.5rem;font-weight:700;color:#1e293b;} .view-description{color:#64748b;margin:.5rem 0 1.5rem;}
    .form-label{display:block;font-size:.875rem;font-weight:500;color:#334155;margin-bottom:.25rem;} .form-select{display:block;width:100%;border-radius:.375rem;border:1px solid #cbd5e1;box-shadow:0 1px 2px 0 rgba(0,0,0,.05);padding:.5rem .75rem;}
    .button-primary-icon,.button-primary,.button-secondary{display:inline-flex;align-items:center;justify-content:center;padding:.5rem 1rem;border:1px solid transparent;border-radius:.375rem;box-shadow:0 1px 2px 0 rgba(0,0,0,.05);font-size:.875rem;font-weight:500;cursor:pointer;transition:background-color .2s,filter .2s;}
    .button-primary-icon{color:#fff;background:#0ea5e9;} .button-primary-icon:hover{background:#0c4a6e;}
    .button-primary{background:#16a34a;color:#fff;} .button-primary:hover{background:#15803d;} .button-primary:disabled{background:#d1d5db;cursor:not-allowed;}
    .button-secondary{background:#fff;color:#334155;border:1px solid #cbd5e1;} .button-secondary:hover{background:#f1f5f9;}
    .selected-drug-item{display:flex;align-items:center;justify-content:space-between;background:#f1f5f9;padding:.5rem;border-radius:.375rem;}
    .remove-drug-btn{color:#94a3b8;background:none;border:none;cursor:pointer;transition:color .2s;} .remove-drug-btn:hover{color:#ef4444;}
    .alert-warning{padding:1rem;border-radius:.375rem;background:#fefce8;border:1px solid #fde047;} .alert-title{font-weight:500;color:#854d0e;}
    .spinner-container{display:flex;justify-content:center;padding:2rem 0;} .spinner{width:2rem;height:2rem;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#0ea5e9;animation:spin 1s linear infinite;} @keyframes spin{to{transform:rotate(360deg);}}
    .output-container{margin-top:1.5rem;padding:1rem;background:#f8fafc;border:1px solid #e2e8f0;border-radius:.5rem;} .output-title{font-size:1.125rem;font-weight:700;color:#0f172a;margin-bottom:.5rem;} .prose{line-height:1.6;} .prose h3{font-size:1.25rem;font-weight:600;margin-top:1em;margin-bottom:.5em;} .prose p,.prose ul{margin-bottom:1em;} .prose ul{list-style-position:inside;} .prose strong{font-weight:600;}
    @media (max-width:680px){header.header-container{flex-direction:column;align-items:flex-start;gap:.75rem;} nav ul.nav-links{flex-wrap:wrap;}}
    </style>
</head>
<body>
    <header class="header-container">
        <div class="logo-container">
            <a href="../index.html"><img src="https://i.imgur.com/5f5Bqf8.png" alt="Logo Umbramed" class="logo"></a>
            <h1>umbramed.org</h1>
        </div>
        <nav>
            <ul class="nav-links">
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="../herramientas.html">Herramientas</a></li>
                <li><a href="../academia.html">Academia</a></li>
                <li><a href="../software.html">Software</a></li>
                <li><a href="../mi-perfil.html">Mi Perfil</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div id="pali-assist-container" class="pali-assist-container">
            <!-- Home View: Role Selection -->
            <div id="home-view">
                <div class="text-center">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-700 mb-2">Bienvenido a la Gu√≠a de Apoyo</h2>
                    <p class="text-slate-500 mb-12 max-w-2xl mx-auto">Seleccione su rol para acceder a las herramientas y recursos personalizados.</p>
                    <div class="role-selection-container">
                        <div class="role-card" id="physician-role-card">
                            <div class="role-icon" aria-hidden="true">ü©∫</div>
                            <h3 class="role-title">Soy M√©dico</h3>
                            <p class="role-description">Acceda al verificador de interacciones en perfusiones y a gu√≠as de dosificaci√≥n.</p>
                        </div>
                        <div class="role-card" id="family-role-card">
                            <div class="role-icon" aria-hidden="true">üë•</div>
                            <h3 class="role-title">Soy Familiar o Cuidador</h3>
                            <p class="role-description">Encuentre consejos pr√°cticos y apoyo emocional para acompa√±ar a su ser querido.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Physician View -->
            <div id="physician-view" class="hidden">
                <button class="back-button">&larr; Volver a la selecci√≥n de rol</button>
                <div class="view-content">
                    <h2 class="view-title">Herramientas para M√©dicos</h2>
                    <p class="view-description">Utilice el verificador de compatibilidad para perfusiones subcut√°neas y genere gu√≠as de preparaci√≥n.</p>
                    
                    <div id="drug-interaction-checker" class="space-y-6">
                        <div>
                            <label for="drug-select" class="form-label">A√±adir F√°rmaco a la Perfusi√≥n</label>
                            <div class="flex gap-2">
                                <select id="drug-select" class="form-select">
                                    <option value="">Seleccione un f√°rmaco...</option>
                                </select>
                                <button id="add-drug-btn" class="button-primary-icon" aria-label="A√±adir">Ôºã</button>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold">F√°rmacos en la Perfusi√≥n:</h4>
                            <ul id="selected-drugs-list" class="mt-2 space-y-2"></ul>
                            <p id="no-drugs-message" class="text-slate-500 mt-2 text-sm">A√±ada f√°rmacos para comenzar.</p>
                        </div>

                        <div id="interaction-warning" class="alert-warning hidden">
                            <div class="flex">
                                <div class="flex-shrink-0" aria-hidden="true">‚ö†Ô∏è</div>
                                <div class="ml-3">
                                    <h3 class="alert-title">Alerta de Interacci√≥n</h3>
                                    <div class="mt-2 text-sm" id="interaction-warning-text"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <button id="generate-protocol-btn" class="button-primary w-full" disabled>Generar Gu√≠a de Preparaci√≥n y Dosificaci√≥n</button>
                            <p id="protocol-error-message" class="text-xs text-center text-red-600 mt-2 hidden">Corrija las interacciones antes de generar la gu√≠a.</p>
                        </div>

                        <div id="protocol-spinner" class="spinner-container hidden"><div class="spinner"></div></div>

                        <div id="protocol-output" class="output-container hidden">
                            <h3 class="output-title">Gu√≠a de Preparaci√≥n Sugerida</h3>
                            <div id="protocol-content" class="prose"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Family View -->
            <div id="family-view" class="hidden">
                <button class="back-button">&larr; Volver a la selecci√≥n de rol</button>
                <div class="view-content">
                    <div class="flex items-start mb-4">
                        <div class="text-sky-500 mr-4 mt-1 flex-shrink-0" aria-hidden="true">üìñ</div>
                        <div>
                            <h2 class="view-title">Carta de Apoyo para la Familia</h2>
                            <p class="view-description">Una gu√≠a unificada con consejos para comprender y acompa√±ar en el proceso final de la vida.</p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div id="generate-letter-container" class="text-center">
                            <p class="mb-4 text-slate-600">Haga clic en el bot√≥n para generar una carta con informaci√≥n y apoyo pr√°ctico.</p>
                            <button id="generate-letter-btn" class="button-primary max-w-xs mx-auto">Generar Carta</button>
                        </div>

                        <div id="letter-spinner" class="spinner-container hidden"><div class="spinner"></div></div>

                        <div id="letter-output" class="hidden">
                            <div id="letter-content" class="prose"></div>
                            <div class="mt-8 text-right">
                                <button id="print-letter-btn" class="button-secondary">üñ®Ô∏è <span class="ml-2">Imprimir Carta</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 umbramed.org. Todos los derechos reservados.</p>
    </footer>

    <!-- Inlined JS -->
    <script>
    document.addEventListener('DOMContentLoaded',()=>{let selectedDrugs=[];let view='home';const ALL_DRUGS=[{id:1,name:'Morfina'},{id:2,name:'Midazolam'},{id:3,name:'Haloperidol'},{id:4,name:'Levomepromazina'},{id:5,name:'Butilescopolamina'},{id:6,name:'Metoclopramida'},{id:7,name:'Dexametasona'},{id:8,name:'Fentanilo'},{id:9,name:'Ketamina'},{id:10,name:'Ondansetr√≥n'}];const homeView=document.getElementById('home-view');const physicianView=document.getElementById('physician-view');const familyView=document.getElementById('family-view');const physicianRoleCard=document.getElementById('physician-role-card');const familyRoleCard=document.getElementById('family-role-card');const backButtons=document.querySelectorAll('.back-button');const drugSelect=document.getElementById('drug-select');const addDrugBtn=document.getElementById('add-drug-btn');const selectedDrugsList=document.getElementById('selected-drugs-list');const noDrugsMessage=document.getElementById('no-drugs-message');const interactionWarning=document.getElementById('interaction-warning');const interactionWarningText=document.getElementById('interaction-warning-text');const generateProtocolBtn=document.getElementById('generate-protocol-btn');const protocolErrorMessage=document.getElementById('protocol-error-message');const protocolSpinner=document.getElementById('protocol-spinner');const protocolOutput=document.getElementById('protocol-output');const protocolContent=document.getElementById('protocol-content');const generateLetterBtn=document.getElementById('generate-letter-btn');const AI_ENDPOINT=window.UMBRA_AI_ENDPOINT||document.querySelector('meta[name="ai-endpoint"]')?.content||null;const AI_TIMEOUT_MS=45000;const sanitizeHTML=r=>{if(!r)return'';let c=r.replace(/<\s*script[^>]*>.*?<\s*\/script>/gis,'').replace(/<\s*style[^>]*>.*?<\s*\/style>/gis,'').replace(/<\s*iframe[^>]*>.*?<\s*\/iframe>/gis,'').replace(/on[a-zA-Z]+\s*=\s*"[^"]*"/g,'').replace(/on[a-zA-Z]+\s*=\s*'[^']*'/g,'').replace(/javascript:/gi,'');c=c.replace(/<(?!\/?(?:p|h1|h2|h3|h4|ul|ol|li|em|strong|br)\b)[^>]*>/gi,'');return c;};const callAI=async({prompt,purpose})=>{if(!AI_ENDPOINT)throw new Error('NO_ENDPOINT_CONFIGURED');const controller=new AbortController();const timeout=setTimeout(()=>controller.abort(),AI_TIMEOUT_MS);try{const res=await fetch(AI_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,purpose}),signal:controller.signal});if(!res.ok)throw new Error(`AI_HTTP_${res.status}`);const data=await res.json();if(!data||typeof data.content!=='string')throw new Error('AI_INVALID_RESPONSE');return sanitizeHTML(data.content);}finally{clearTimeout(timeout);}};const buildProtocolPrompt=d=>`Genera una GU√çA CL√çNICA estructurada en HTML SIMPLE para la PREPARACI√ìN y DOSIFICACI√ìN de una perfusi√≥n subcut√°nea continua que incluye exactamente estos f√°rmacos: ${d.join(', ')}. Incluir secciones claras con encabezados h3: 1) Preparaci√≥n (diluyente, volumen est√°ndar, orden de carga si relevante) 2) Compatibilidad general 3) Dosis orientativas iniciales (expresar rangos razonables por 24h; si un f√°rmaco requiere titulaci√≥n individual ind√≠calo) 4) Recomendaciones de titulaci√≥n y monitorizaci√≥n 5) Estabilidad y consideraciones de mezcla 6) Advertencias y necesidad de individualizaci√≥n. Responder solo con HTML permitido (p, h3, ul, li, strong, em, br). Espa√±ol.`;const buildFamilyLetterPrompt=()=>`Redacta una CARTA DE APOYO (tono emp√°tico y profesional) para familiares y cuidadores de un paciente en fase terminal. Estructura en HTML simple con h2/h3 y listas. Secciones: Comprender s√≠ntomas frecuentes (apetito, sue√±o, respiraci√≥n, confusi√≥n), Apoyo emocional y comunicaci√≥n, Manejo pr√°ctico b√°sico, Autocuidado del cuidador, Cu√°ndo contactar con el equipo sanitario (signos de alarma), Mensaje final de agradecimiento y dignidad. No incluir recomendaciones m√©dicas invasivas ni promesas irreales. Solo HTML permitido (p, h2, h3, ul, li, strong, em, br). Espa√±ol.`;const generateDosingProtocol=async n=>{const p=buildProtocolPrompt(n);return await callAI({prompt:p,purpose:'protocol'});};const generateFamilyAdvice=async()=>{const p=buildFamilyLetterPrompt();return await callAI({prompt:p,purpose:'family_letter'});};const generateLetterContainer=document.getElementById('generate-letter-container');const letterSpinner=document.getElementById('letter-spinner');const letterOutput=document.getElementById('letter-output');const letterContent=document.getElementById('letter-content');const printLetterBtn=document.getElementById('print-letter-btn');const updateView=()=>{homeView.classList.add('hidden');physicianView.classList.add('hidden');familyView.classList.add('hidden');if(view==='home')homeView.classList.remove('hidden');if(view==='physician')physicianView.classList.remove('hidden');if(view==='family')familyView.classList.remove('hidden');};const populateDrugSelect=()=>{const available=ALL_DRUGS.filter(d=>!selectedDrugs.some(sd=>sd.id===d.id));drugSelect.innerHTML='<option value="">Seleccione un f√°rmaco...</option>';available.forEach(d=>{const o=document.createElement('option');o.value=d.id;o.textContent=d.name;drugSelect.appendChild(o);});};const renderSelectedDrugs=()=>{selectedDrugsList.innerHTML='';if(selectedDrugs.length>0){noDrugsMessage.classList.add('hidden');selectedDrugs.forEach(drug=>{const li=document.createElement('li');li.className='selected-drug-item';li.innerHTML=`<span>${drug.name}</span><button data-id="${drug.id}" class="remove-drug-btn" aria-label="Eliminar">üóëÔ∏è</button>`;selectedDrugsList.appendChild(li);});}else{noDrugsMessage.classList.remove('hidden');}};const checkForInteraction=()=>{let warning='';for(let i=0;i<selectedDrugs.length;i++){for(let j=i+1;j<selectedDrugs.length;j++){const A=selectedDrugs[i].name;const B=selectedDrugs[j].name;if(PRECIPITATE_INTERACTIONS[A]?.includes(B)||PRECIPITATE_INTERACTIONS[B]?.includes(A)){warning=`¬°Atenci√≥n! Se ha detectado una interacci√≥n con riesgo de precipitaci√≥n entre ${A} y ${B}.`;break;}}if(warning)break;}if(warning){interactionWarningText.textContent=warning;interactionWarning.classList.remove('hidden');generateProtocolBtn.disabled=true;protocolErrorMessage.classList.remove('hidden');}else{interactionWarning.classList.add('hidden');generateProtocolBtn.disabled=selectedDrugs.length===0;protocolErrorMessage.classList.add('hidden');}};const handleAddDrug=()=>{const id=parseInt(drugSelect.value);if(!id)return;const drug=ALL_DRUGS.find(d=>d.id===id);if(drug){selectedDrugs.push(drug);populateDrugSelect();renderSelectedDrugs();checkForInteraction();drugSelect.value='';}};const handleRemoveDrug=id=>{selectedDrugs=selectedDrugs.filter(d=>d.id!==id);populateDrugSelect();renderSelectedDrugs();checkForInteraction();};const handleGenerateProtocol=async()=>{if(selectedDrugs.length===0)return;protocolSpinner.classList.remove('hidden');protocolOutput.classList.add('hidden');protocolContent.innerHTML='';generateProtocolBtn.disabled=true;generateProtocolBtn.textContent='Generando‚Ä¶';const names=selectedDrugs.map(d=>d.name);try{const protocol=await generateDosingProtocol(names);protocolContent.innerHTML=protocol;protocolOutput.classList.remove('hidden');}catch(err){let msg;if(err.message==='NO_ENDPOINT_CONFIGURED'){msg='<p><strong>Configuraci√≥n requerida:</strong> No se ha definido un endpoint de IA. Defina window.UMBRA_AI_ENDPOINT o meta name="ai-endpoint".</p>';}else if(err.name==='AbortError'){msg='<p><strong>Tiempo excedido:</strong> El servicio de IA no respondi√≥ a tiempo. Intente de nuevo.</p>';}else{msg='<p><strong>Error:</strong> No se pudo generar la gu√≠a. Reintente m√°s tarde.</p>';}protocolContent.innerHTML=msg;protocolOutput.classList.remove('hidden');}finally{protocolSpinner.classList.add('hidden');generateProtocolBtn.disabled=false;generateProtocolBtn.textContent='Generar Gu√≠a de Preparaci√≥n y Dosificaci√≥n';}};const handleGenerateLetter=async()=>{generateLetterContainer.classList.add('hidden');letterSpinner.classList.remove('hidden');letterOutput.classList.add('hidden');letterContent.innerHTML='';try{const advice=await generateFamilyAdvice();letterContent.innerHTML=advice;}catch(err){let msg;if(err.message==='NO_ENDPOINT_CONFIGURED'){msg='<p><strong>Configuraci√≥n requerida:</strong> Falta endpoint IA. A√±ada window.UMBRA_AI_ENDPOINT o meta name="ai-endpoint".</p>';}else if(err.name==='AbortError'){msg='<p><strong>Tiempo excedido:</strong> El servicio tard√≥ demasiado.</p>';}else{msg='<p><strong>Error:</strong> No se pudo generar la carta. Intente m√°s tarde.</p>'; }letterContent.innerHTML=msg;}finally{letterSpinner.classList.add('hidden');letterOutput.classList.remove('hidden');}};const handlePrintLetter=()=>{const c=letterContent.innerHTML;const w=window.open('','','height=800,width=800');if(!w){alert('Permita ventanas emergentes para imprimir.');return;}w.document.write('<html><head><title>Carta para Familiares y Cuidadores</title><style>body{font-family:sans-serif;padding:2rem;} h1{font-size:1.5rem;font-weight:bold;margin-bottom:1rem;} ul{padding-left:20px;} </style></head><body>'+c+'</body></html>');w.document.close();setTimeout(()=>{w.focus();w.print();w.close();},750);};physicianRoleCard.addEventListener('click',()=>{view='physician';updateView();});familyRoleCard.addEventListener('click',()=>{view='family';updateView();});backButtons.forEach(b=>b.addEventListener('click',()=>{view='home';updateView();}));addDrugBtn.addEventListener('click',handleAddDrug);selectedDrugsList.addEventListener('click',e=>{const btn=e.target.closest('.remove-drug-btn');if(btn){handleRemoveDrug(parseInt(btn.dataset.id));}});generateProtocolBtn.addEventListener('click',handleGenerateProtocol);generateLetterBtn.addEventListener('click',handleGenerateLetter);printLetterBtn.addEventListener('click',handlePrintLetter);populateDrugSelect();updateView();(function(){document.querySelectorAll('a[href$=".html"]').forEach(a=>{try{new URL(a.getAttribute('href'),location.origin);}catch(e){console.warn('[VALIDATION] href inv√°lido',a.getAttribute('href'));}})})();});
    const PRECIPITATE_INTERACTIONS={'Morfina':['Midazolam','Haloperidol'],'Midazolam':['Levomepromazina'],'Haloperidol':['Levomepromazina'],'Levomepromazina':['Metoclopramida'],'Butilescopolamina':['Metoclopramida'],'Metoclopramida':['Haloperidol'],'Dexametasona':['Ketamina'],'Fentanilo':['Ketamina']};
    </script>
</body>
</html>
